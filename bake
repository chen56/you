#!/usr/bin/env bash

# On Mac OS, readlink -f doesn't work, so use._real_path get the real path of the file
#_real_path() {  [[ $1 = /* ]] && echo "$1" || echo "$PWD/${1#./}" ; }
#_ROOT_BAKE_PATH="$(_real_path "${BASH_SOURCE[0]}")"
#_ROOT_DIR="$(dirname "$_ROOT_BAKE_PATH")"
_ROOT_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)
_ROOT_BAKE_PATH="${_ROOT_DIR}/bake"

# è¿›å…¥è„šæœ¬æ‰€åœ¨ç›®å½•ï¼Œè¿™æ ·ä¸Šä¸‹æ–‡å°±æ˜¯æœ¬é¡¹ç›®äº†
cd "$_ROOT_DIR" || exit 200

# include common script
source "packages/you_bake/bake.bash"

declare -A _pkgs=(
    ["root"]="$_ROOT_DIR"
    ["bake"]="$_ROOT_DIR/packages/you_bake"
    ["you_dart"]="$_ROOT_DIR/packages/you_dart"
    ["you_flutter"]="$_ROOT_DIR/packages/you_flutter"
    ["you_cli"]="$_ROOT_DIR/packages/you_cli"
    ["learn_dart"]="$_ROOT_DIR/notes/learn_dart"
    ["flutter_web"]="$_ROOT_DIR/notes/flutter_web"
    ["qwik"]="$_ROOT_DIR/notes/qwik"
    ["shell"]="$_ROOT_DIR/notes/shell"
)


####################################################
# app entry script & _root cmd
####################################################
bake.cmd --cmd ls --desc "<mono> mono project manage: ./bake pkgs <ls|run>"
bake.cmd --cmd run --desc "<mono> run cmd on all pkg,Usage: ./bake pkgs run [any cmd]"

bake.cmd --cmd root --desc "$( cat <<-EOF

 ___  _        _    _                    _  _       _
| __|| | _  _ | |_ | |_  ___  _ _       | \| | ___ | |_  ___
| _| | || || ||  _||  _|/ -_)| '_|      | .  |/ _ \|  _|/ -_)
|_|  |_| \_._| \__| \__|\___||_|        |_|\_|\___/ \__|\___|

https://github.com/chen56/you/flutter_web

PWD: $PWD

Usage:
 ./bake [cmd] [opts] [args...]

Examples:
 ./bake                           # same as  './bake -h'
 ./bake -h                        # show all commands help
 ./bake -h --debug                # show all commands help , include internal function

 ./bake flutter dev               # == cd notes/flutter_web && flutter run --device-id macos

 ./bake test                      # test all projects
 ./bake build                     # defalut build == flutter build web --web-renderer html
 ./bake preview                   # defalut preview == start server at web build
 ./bake test                      # test all projects

 ./bake pkgs ls                   # show all mono project
 ./bake pkgs run pwd              # run "pwd" on all mono project dir
 ./bake pkgs run flutter pub get  # run "flutter pub get" on all mono project dir
EOF
)"

##########################################
#  å…¬å…±å‡½æ•°åŒºï¼Œåˆå§‹åŒ–è¯­å¥å’Œå˜é‡åªæ”¾è„šæœ¬å¤´å°¾
##########################################
__is_cmd() {
  command -v "$1" >/dev/null 2>&1
}


# åœ¨æ‰€æœ‰é¡¹ç›®ä¸Šè¿è¡ŒæŸå‘½ä»¤
# Usage:    __run_all <sub cmd>
# Example:  __run_all clean
#     run =>  note.clean
#             mate.clean
#             flutter_web.clean
#             ...
__run_all() {
  local subcmd="$1"
  if [[ "$subcmd" == "" ]] ; then
    echo "ç¼ºsubcmdå‚æ•° Usage:__run_all <sub cmd>";
    return 100;
  fi
  for pkg in "${!_pkgs[@]}"; do
    if _is_cmd "$pkg.$subcmd" ; then "$pkg.$subcmd" ; fi
  done
}

# å…ˆcdåˆ°é¡¹ç›®ç›®å½•ï¼Œå†printä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæœ€åæ‰§è¡Œ
# Usage:   __run <pkg> <some cmd>
# Example: __run flutter_web pwd
__run() {
  local pkg=${1:?required project arg,Usage: __run <pkg>}
  shift
  local cmd="${1}"
#  [[ "$cmd" != "" ]]  # å¦‚æœæœ‰cmdï¼Œå»æ‰ç¬¬1ä¸ªcmd,å‰©ä½™çš„æ˜¯å®ƒçš„å‚æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±ç±»ä¼¼äºåœ¨æ§åˆ¶å°ä¸Šæ‰“äº†ä¸ªä¼šè½¦ä¸€æ ·ä»»ä»–å»å§

  # è¿›å…¥å·¥ä½œç›®å½•
  local workdir="${_pkgs[$pkg]}"
  pushd "$workdir" > /dev/null || { echo "pushd failure"; exit 200; }

  local caller_line;
  caller_line=$(caller 0 | awk '{print $1}')

  if ! _is_cmd "$cmd" ; then
    echo "$_ROOT_BAKE_PATH:$caller_line âšªï¸ â–¶ï¸${FUNCNAME[1]}() â–¶ï¸ã€$PWD$ $*ã€‘"
  else
    echo "$_ROOT_BAKE_PATH:$caller_line ğŸ”µ â–¶ï¸${FUNCNAME[1]}() â–¶ï¸ã€$PWD$ $*ã€‘"
    "$@"
  fi
  # é€€å‡ºå·¥ä½œç›®å½•ï¼Œä¸å¼„è„ç¯å¢ƒ,ä¸éœ€è¦æ‰“å°popdæ‰§è¡Œç»“æœ
  popd > /dev/null || { echo "popd failure"; exit 200; }
}

##########################################
# app cmd script
# åº”ç”¨çš„å‘½ä»¤è„šæœ¬
##########################################


pkgs()     { for pkg in ${!_pkgs[*]} ; do echo "$pkg:${_pkgs[$pkg]}"; done;  }
run()      { for pkg in ${!_pkgs[*]} ; do __run "$pkg" "$@" ;   done         }
install()  { __run_all install;                                              }
get()      { __run_all install;                                              }
build()    { __run_all build;                                                }
upgrade()  { __run_all upgrade;                                              }
clean()    { __run_all clean;                                                }
test()     { __run_all test;                                                 }
gen()      { __run_all gen;                                                  }
publish()  { __run_all publish;                                              }
dart_fix() { run dart fix $@;                                                }

# æ ¹é¡¹ç›®ï¼Œä¸»è¦æ˜¯bin/è¾…åŠ©å·¥å…·ç­‰
root.run()              { __run root "$@";                                          }

bake.run()              { __run bake "$@";                                          }
bake.test()             { __run bake ./test.bash test;                              }

_you_dart_internal.run()     { __run _you_dart_internal "$@";                                 }
_you_dart_internal.install() { __run _you_dart_internal flutter pub get;                      }
_you_dart_internal.clean()   { __run _you_dart_internal flutter clean; rm -rf build;          }
_you_dart_internal.upgrade() { __run _you_dart_internal flutter pub outdated ;
                               __run _you_dart_internal flutter pub upgrade ;                 }
_you_dart_internal.test()    { __run _you_dart_internal flutter test;                         }
_you_dart_internal.publish() { __run _you_dart_internal flutter pub publish;                  }

you_dart.run()     { __run you_dart "$@";                                 }
you_dart.install() { __run you_dart flutter pub get;                      }
you_dart.clean()   { __run you_dart flutter clean; rm -rf build;          }
you_dart.upgrade() { __run you_dart flutter pub outdated ;
                     __run you_dart flutter pub upgrade ;                 }
you_dart.test()    { __run you_dart flutter test;                         }
you_dart.publish() { __run you_dart flutter pub publish;                  }

you_flutter.run()     { __run you_flutter "$@";                                 }
you_flutter.install() { __run you_flutter flutter pub get;                      }
you_flutter.clean()   { __run you_flutter flutter clean; rm -rf build;          }
you_flutter.upgrade() { __run you_flutter flutter pub outdated ;
                        __run you_flutter flutter pub upgrade ;                 }
you_flutter.test()    { __run you_flutter flutter test;                         }
you_flutter.publish() { __run you_flutter flutter pub publish;                  }

you_cli.run()         { __run you_cli "$@";                                     }
you_cli.test()        { __run you_cli dart test;                                }
you_cli.install()     { __run you_cli flutter pub get;                          }
you_cli.clean()       { __run you_cli flutter clean; rm -rf build;              }
you_cli.upgrade()     { __run you_cli flutter pub outdated ;
                        __run you_cli flutter pub upgrade ;                     }
you_cli.publish()     { __run you_cli flutter pub publish;                      }


learn_dart.run()        { __run learn_dart "$@";                                     }
learn_dart.install()    { __run learn_dart dart pub get ;                            }
learn_dart.clean()      { __run learn_dart rm -rf
                          __run learn_dart rm -rf .dart_tool;                        }
learn_dart.upgrade()    { __run learn_dart flutter pub outdated ;
                          __run learn_dart dart pub upgrade ;                        }
learn_dart.study()      { __run learn_dart dart test;                                }
# skwasmæ— æ³•è¿è¡Œ
  #   http-server ä¸æ”¯æŒbase hrefè®¾ç½®ï¼Œæ‰€ä»¥å•ç‹¬build,å¹¶è®¾ç½®base-hrefä¸º"/",è€Œgithub-pagesçš„base-hrefå¿…é¡»æ˜¯repositoryå
  #   	npx http-server ./flutter_web/build/web --port 8000
    # flutter pub global activate dhttpd
    # run p.flutter_web dhttpd --path ./build/web --port 8080 '--headers=Cross-Origin-Embedder-Policy=credentialless;Cross-Origin-Opener-Policy=same-origin'
# install:
# - flutter pub global activate dhttpd
# - deno
flutter_web.run()      { __run flutter_web "$@"  ;                           }
flutter_web.install()  { __run flutter_web flutter pub get ;                 }
flutter_web.clean()    { __run flutter_web flutter clean;
                         rm -rf build;                                       }
flutter_web.upgrade()  { __run flutter_web flutter pub outdated ;
                         __run flutter_web flutter pub upgrade ;             }
flutter_web.gen()      { #__run root dart run packages/you_cli/bin/cli.dart gen all --dir notes/flutter_web/;
                         __run root dart run packages/you_cli/bin/cli.dart gen routes  --dir notes/flutter_web/ # --async
}
flutter_web.dev()      { flutter_web.dev_html ;                              }
flutter_web.build()    { flutter_web.build_html ;                            }
flutter_web.preview()  { flutter_web.build_html;
                         flutter_web.server_deno;                            }

flutter_web.dev_html()              { __run flutter_web flutter run --web-port 8888 --web-renderer html --device-id chrome "$@"; }
flutter_web.dev_macos()             { __run flutter_web flutter run --device-id macos "$@"; }
flutter_web.build_html()            { __run flutter_web flutter build web   --release --tree-shake-icons --web-renderer html       --source-maps --output build/web/you/flutter_web --base-href "/you/flutter_web/" --no-web-resources-cdn "$@" ; }
flutter_web.build_web_skwasm()      { __run flutter_web flutter build web   --release --tree-shake-icons --web-renderer skwasm     --source-maps --output build/web/you/flutter_web --base-href "/you/flutter_web/" --no-web-resources-cdn "$@" ; }
flutter_web.build_web_canvaskit()   { __run flutter_web flutter build web   --release --tree-shake-icons --web-renderer canvaskit  --source-maps --output build/web/you/flutter_web --base-href "/you/flutter_web/" --no-web-resources-cdn "$@" ; }
flutter_web.build_wasm()            { __run flutter_web flutter build web   --release --tree-shake-icons --wasm                    --source-maps --output build/web/you/flutter_web --base-href "/you/flutter_web/" --no-web-resources-cdn "$@" ; }
flutter_web.build_macos()           { __run flutter_web flutter build macos --release --tree-shake-icons "$@";  }
flutter_web.server_dhttpd()         { echo "http://localhost:8080/you/flutter_web";
                                      __run flutter_web dhttpd --path ./build/web --port 8080 '--headers=Cross-Origin-Embedder-Policy=credentialless;Cross-Origin-Opener-Policy=same-origin';  }
flutter_web.server_deno()           { echo "http://localhost:8080/you/flutter_web";
                                      __run flutter_web deno run --allow-env --allow-read --allow-sys --allow-net npm:http-server ./build/web --port 8080 -g --brotli; }


# github å‘å¸ƒæ—¶ä½¿ç”¨,å‚è€ƒ[.github/workflows/*.yaml]
docker.build()   { __run root docker build --progress plain --build-arg test=on --tag chen56/you:latest . ;
                   __run root mkdir -p build;
                   __run root sh -c "docker run --rm --workdir /usr/share/nginx/html/ chen56/you tar cf - ./ | ( cd build; tar xf -)";       }
docker.preview() { __run root echo "note preview http://localhost:8888/you/flutter_web";
                   __run root docker run --rm --name you -p 8888:80 -u root:root chen56/you;                                                 }
docker.debug()   { __run root docker run -v "$PWD:/home/flutter/you" --workdir /home/flutter/you --rm -it fischerscode/flutter:3.19.0 bash ; }
docker.exec()    { __run root docker exec -it --workdir /usr/share/nginx/html/you/ you bash ;                                                }
docker.push()    { __run root docker image push chen56/you:latest ;                                                                          }


info() {
  echo "PWD         :  $PWD"
  echo "_ROOT_DIR   :  $_ROOT_DIR"
  echo
  echo "## pkgs"
  ls
  echo
}

temp(){

  # æŒ‡å®šéœ€è¦éå†çš„ç›®å½•ï¼Œä¾‹å¦‚å½“å‰ç›®å½•å¯ä»¥ä½¿ç”¨ "."
  directory="notes/flutter_web/lib"

  # éå†ç›®å½•ä¸­çš„æ‰€æœ‰note.dartæ–‡ä»¶
  for file in $(find 'notes/flutter_web/lib' -type f -name 'note.json') ; do
#    echo "xxx $file"
#      # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
      if [ -f "$file" ]; then
          # æ„å»ºæ–°çš„æ–‡ä»¶åï¼Œå³å°†note.dartæ›¿æ¢ä¸ºpage.dart
          new_file="${file//note.json/page.json}"
          # æ‰§è¡Œé‡å‘½åæ“ä½œ
          git mv "$file" "$new_file"
          echo "mv $file to $new_file"
      fi
  done
}

bake.go "$@"